# Story 2.1: Advanced Chart Library

## Status
Draft

## Story
As a data analyst, I want 20+ chart types (including statistical and geographic) with themes, animations, and large-data performance so that I can build expressive dashboards.

## Scope
- In-scope: New chart components, config model, palette/theming, perf optimizations, docs and tests.
- Out-of-scope: Predictive analytics (covered later), custom plugin charts (5.1).

## Acceptance Criteria (Given/When/Then)
1) Chart Catalog
- Given the Dashboard Builder is open
- When I open the Component Palette
- Then I can see and drag 20+ charts grouped by category: basic (bar/line/area/pie/donut/scatter/bubble/stacked/100% stacked), statistical (histogram/box/violin/candlestick/density/radar), relational (heatmap/treemap/sunburst/sankey/chord), geographic (choropleth/bubble map), combo (bar+line, dual-axis)

2) Theming & Palettes
- Given a chart is selected
- When I choose a color palette or theme (light/dark/custom)
- Then colors, typography, gridlines, and backgrounds update consistently and pass WCAG AA contrast

3) Animations & Transitions
- Given data updates occur
- When data changes within the same chart instance
- Then enter/update/exit animations play smoothly with configurable duration and easing (can be disabled)

4) Large Data Performance
- Given a dataset of 100k points (for applicable types)
- When I render the chart
- Then initial render < 3s, interactions remain responsive (> 30 FPS), and memory usage < 500MB via sampling/aggregation/canvas fallback

5) Configuration & Validation
- Given a chart is on canvas
- When I open the Chart Config Panel
- Then I can set axes, labels, legends, formats, tooltips, reference lines/bands, thresholds; invalid configs show validation errors

6) Accessibility
- Given a chart is focused
- When I navigate with keyboard
- Then interactive elements are reachable, tooltips are screen-reader compatible, and charts have descriptive titles/ARIA labels

7) Testing & Docs
- Given the repo builds
- When I run tests
- Then unit/integration/E2E tests for chart library pass and docs include usage, props, and examples

## API/Component Specifications
- Namespace: apps/web/src/components/charts/
- Common Props (all charts):
  - data: array | typed series; config: ChartConfig; theme: ChartTheme; loading: boolean; error?: string
  - interactions?: { hover: boolean; select: boolean; onPointClick?: (p)=>void }
  - performance?: { rendering: 'svg'|'canvas'|'auto'; sampleThreshold: number; maxPoints: number }
- ChartConfig (shared): title, legend, axes[x/y], grid, series[], numberFormat, dateFormat, referenceLines[], thresholds[]
- Theming: apps/web/src/themes/chartThemes.ts (light, dark, high-contrast) with override API
- Palettes: apps/web/src/utils/colorPalettes.ts (categorical/sequential/diverging + custom builder)

## Data Model (Frontend)
- types/charts.ts
  - ChartType = 'bar'|'line'|'area'|'pie'|'donut'|'scatter'|'bubble'|'stackedBar'|'percentStackedBar'|'histogram'|'box'|'violin'|'candlestick'|'density'|'radar'|'heatmap'|'treemap'|'sunburst'|'sankey'|'chord'|'choropleth'|'geoBubble'|'combo'
  - Series: { id, name, data: { x: number|date|string, y: number }[] }

## Key Interactions
- Tooltips: shared crosshair for time series; custom formatter
- Legends: clickable to toggle series; overflow handling
- Zoom/Pan: time and value axes where applicable; reset control

## Security & Privacy
- No PII in chart configs; sanitize tooltips/HTML; CSP compatible; avoid eval; dependency SCA

## Performance Targets
- P95 initial render: <= 1500ms (<= 3s for 100k points); interaction latency < 50ms; animations 60 FPS target
- Strategies: windowing/sampling, canvas fallback, memoization, off-main-thread computations (Web Worker for heavy transforms)

## Observability
- Telemetry: chartRenderStart/End (ms), seriesCount, pointCount, rendererMode, animationEnabled, errors
- Expose counters/histograms to frontend metrics collector

## Rollout/Backout
- Feature flags per chart category; safe rollout by enabling sets
- Backout: toggle flag to revert to basic charts only; no data migration needed

## Risks & Mitigations
- R: Large data freezes UI → M: sampling, canvas, workers, progressive rendering
- R: Accessibility gaps → M: audits with axe-core, keyboard tests
- R: Theming contrast → M: palette validator enforcing WCAG AA

## UX/Design Notes
- Consistent paddings, 12-column builder grid alignment; tooltip spacing and typography; theming switch in builder toolbar

## Testing Strategy
- Unit: rendering utils, scales, color palettes, formatters
- Component: each chart with small/medium/large datasets, edge cases (empty, NaN)
- Integration: builder palette add/remove; config panel live updates
- E2E: dashboard with 6+ charts, theme switch, large data scenario
- Accessibility tests: keyboard nav, aria labels, contrast checks

## Tasks / Subtasks
1. Core Infrastructure
- Create chart types, common props, config schemas, theming and palette modules
- Add canvas renderer and auto mode
- Add performance utilities (sampling, aggregation)
2. Chart Implementations
- Implement all 20+ chart components with shared primitives
- Add docs examples for each
3. Tooling & Docs
- Storybook stories for charts
- MDX docs: usage, props, performance guidance
4. Testing
- Jest + RTL for components; visual regression (percy/playwright) for key charts

## Non-Functional Requirements
- Security: no unsafe HTML; CSP-safe; dependencies scanned
- Performance: targets above; memory < 500MB for 100k points
- Reliability: unit/integration/E2E > 85% coverage for charts
- Maintainability: typed configs; lint rules preventing heavy renders on main thread

## Dependencies
- Recharts 2.8.0 (basic), D3 7.x (custom), canvas APIs; optional topojson for geo

## Definition of Done Checklist
- [ ] 20+ charts implemented with docs/examples
- [ ] Themes and palettes integrated with validation
- [ ] Performance meets targets (benchmarks committed)
- [ ] A11y checks pass (axe, keyboard)
- [ ] Telemetry events emitted and documented
- [ ] Tests >= 85% for chart modules

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 2.0 | Regenerated with exhaustive spec | Bob |

## Dev Agent Record
- Agent Model Used: (to be filled by Dev)
- Debug Log References: (to be filled by Dev)
- Completion Notes List: (to be filled by Dev)
- File List: (to be filled by Dev)

## QA Results
- To be filled by QA

