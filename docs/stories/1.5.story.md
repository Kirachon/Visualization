# Story 1.5: User Management & Sharing

## Status
Partially Complete (Backend Only)

## Story

**As a** team lead,
**I want** to manage users and share dashboards with team members,
**so that** collaboration on data insights is possible.

## Acceptance Criteria

1. User management interface (create, edit, delete users)
2. Dashboard sharing with view/edit permissions
3. Public link generation for dashboard sharing
4. Basic audit logging of user actions
5. User profile management
6. Password reset functionality
7. Session management with automatic logout

## Tasks / Subtasks

- [x] Task 1: Enhance User Model and Database Schema (AC: 1, 5)
  - [x] Update `apps/api/src/models/User.ts` with profile fields
  - [x] Add database migration for user profile fields (if needed)
  - [x] Add indexes for email and username lookups
  - [x] Write unit tests for User model enhancements

- [x] Task 2: Implement User Management Service (AC: 1, 5, 6)
  - [x] Update `apps/api/src/services/authService.ts` or create `userService.ts`
  - [x] Implement createUser() with password hashing
  - [x] Implement getUserById() and listUsers() for tenant
  - [x] Implement updateUser() for profile updates
  - [x] Implement deleteUser() with soft delete
  - [x] Implement initiatePasswordReset() with token generation
  - [x] Implement resetPassword() with token validation
  - [x] Write unit tests for all service methods

- [x] Task 3: Create User Management Controller and Routes (AC: 1, 5, 6)
  - [x] Create `apps/api/src/controllers/userController.ts`
  - [x] Implement POST /api/v1/users (create user - admin only)
  - [x] Implement GET /api/v1/users (list users - admin only)
  - [x] Implement GET /api/v1/users/:id (get user)
  - [x] Implement PUT /api/v1/users/:id (update user)
  - [x] Implement DELETE /api/v1/users/:id (delete user - admin only)
  - [x] Implement POST /api/v1/users/password-reset/initiate
  - [x] Implement POST /api/v1/users/password-reset/complete
  - [x] Add role-based authorization middleware
  - [x] Write integration tests for all endpoints

- [x] Task 4: Implement Dashboard Sharing Service (AC: 2, 3)
  - [x] Update `apps/api/src/services/dashboardService.ts`
  - [x] Implement shareDashboard() with permission types (view, edit)
  - [x] Implement revokeDashboardAccess()
  - [x] Implement generatePublicLink() with unique token
  - [x] Implement getPublicDashboard() for public access
  - [x] Implement listSharedDashboards() for user
  - [x] Write unit tests for sharing functionality

- [x] Task 5: Create Dashboard Sharing Controller and Routes (AC: 2, 3)
  - [x] Update `apps/api/src/controllers/dashboardController.ts`
  - [x] Implement POST /api/v1/dashboards/:id/share (share dashboard)
  - [x] Implement DELETE /api/v1/dashboards/:id/share/:userId (revoke access)
  - [x] Implement POST /api/v1/dashboards/:id/public-link (generate public link)
  - [x] Implement GET /api/v1/public/dashboards/:token (access public dashboard)
  - [x] Implement GET /api/v1/dashboards/shared (list shared dashboards)
  - [x] Add permission validation middleware
  - [x] Write integration tests for sharing endpoints

- [x] Task 6: Implement Audit Logging Service (AC: 4)
  - [x] Create `apps/api/src/services/auditService.ts`
  - [x] Implement logAction() with action type, user, resource, details
  - [x] Create audit_logs table migration
  - [x] Implement getAuditLogs() with filtering and pagination
  - [x] Add audit logging middleware for sensitive operations
  - [x] Write unit tests for audit service

- [x] Task 7: Implement Session Management (AC: 7)
  - [x] Update `apps/api/src/services/authService.ts`
  - [x] Implement session tracking in database or Redis
  - [x] Add session expiration (configurable, default 1 hour)
  - [x] Implement automatic logout on inactivity
  - [x] Add session refresh on activity
  - [x] Implement logout all sessions functionality
  - [x] Write unit tests for session management

- [-] Task 8: Create User Management UI (AC: 1) - DEFERRED (Requires React/UI infrastructure)
  - [-] Create `apps/web/src/pages/UserManager.tsx`
  - [-] Create `apps/web/src/components/forms/UserForm.tsx`
  - [-] Implement user list view with search and filtering
  - [-] Add create user dialog (admin only)
  - [-] Add edit user dialog
  - [-] Add delete user confirmation (admin only)
  - [-] Add role assignment dropdown
  - [-] Write unit tests for user management components

- [-] Task 9: Create User Profile UI (AC: 5) - DEFERRED (Requires React/UI infrastructure)
  - [-] Create `apps/web/src/pages/UserProfile.tsx`
  - [-] Add profile information display and editing
  - [-] Add password change functionality
  - [-] Add profile picture upload (optional)
  - [-] Add user preferences settings
  - [-] Write unit tests for profile components

- [-] Task 10: Create Password Reset UI (AC: 6) - DEFERRED (Requires React/UI infrastructure)
  - [-] Create `apps/web/src/pages/PasswordReset.tsx`
  - [-] Add "Forgot Password" link on login page
  - [-] Implement email input for password reset initiation
  - [-] Create password reset confirmation page
  - [-] Add new password input with validation
  - [-] Display success/error messages
  - [-] Write unit tests for password reset flow

- [-] Task 11: Create Dashboard Sharing UI (AC: 2, 3) - DEFERRED (Requires React/UI infrastructure)
  - [-] Create `apps/web/src/components/dashboard/ShareDialog.tsx`
  - [-] Add share button to dashboard toolbar
  - [-] Implement user search for sharing
  - [-] Add permission selector (view, edit)
  - [-] Display list of users with access
  - [-] Add revoke access button
  - [-] Implement public link generation with copy button
  - [-] Write unit tests for sharing components

- [-] Task 12: Implement Session Timeout UI (AC: 7) - DEFERRED (Requires React/UI infrastructure)
  - [-] Create `apps/web/src/components/common/SessionTimeout.tsx`
  - [-] Add inactivity detection (track mouse/keyboard events)
  - [-] Display warning dialog before auto-logout (5 minutes before)
  - [-] Implement "Stay Logged In" button to refresh session
  - [-] Implement automatic logout and redirect to login
  - [-] Write unit tests for session timeout

- [-] Task 13: Create Frontend Services and State Management (AC: 1, 2, 5, 6) - DEFERRED (Requires React/UI infrastructure)
  - [-] Create `apps/web/src/services/userService.ts`
  - [-] Update `apps/web/src/stores/authSlice.ts` for session management
  - [-] Create `apps/web/src/stores/userSlice.ts` for user management
  - [-] Implement API client methods for all user operations
  - [-] Add Redux actions and reducers
  - [-] Write unit tests for services and state

- [ ] Task 14: Add E2E Tests (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create `apps/api/src/__tests__/e2e/user.e2e.test.ts`
  - [ ] Test user creation and management (admin)
  - [ ] Test dashboard sharing workflow
  - [ ] Test public link generation and access
  - [ ] Test password reset flow
  - [ ] Test session timeout and automatic logout
  - [ ] Test audit logging

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 Dev Agent Record]
- Authentication system uses JWT tokens in httpOnly cookies
- Password hashing uses bcrypt with 10 rounds
- Role-based access control is implemented (Viewer, Admin)
- Input validation uses Joi schemas
- Error handling uses custom error classes

[Source: Story 1.2, 1.3, 1.4 Dev Agent Records]
- Data sources, dashboards, and visualizations are implemented
- Permission checks are in place for resource access
- Tenant isolation is enforced

### Data Models
[Source: docs/architecture/data-models.md, docs/architecture/database-schema.md]

**User Model (Enhanced):**
```typescript
interface User {
  id: string;
  username: string;
  email: string;
  passwordHash: string;
  firstName: string;
  lastName: string;
  tenantId: string;
  roleId: string;
  isActive: boolean;
  profilePicture?: string;
  preferences?: UserPreferences;
  createdAt: Date;
  updatedAt: Date;
  lastLoginAt: Date;
}

interface UserPreferences {
  theme?: 'light' | 'dark';
  language?: string;
  timezone?: string;
  emailNotifications?: boolean;
}
```

**Dashboard Permission Model:**
```typescript
interface DashboardPermission {
  id: string;
  dashboardId: string;
  userId?: string;
  roleId?: string;
  permissionType: 'view' | 'edit' | 'share' | 'admin';
  grantedBy: string;
  grantedAt: Date;
}

interface PublicDashboardLink {
  id: string;
  dashboardId: string;
  token: string;
  expiresAt?: Date;
  createdBy: string;
  createdAt: Date;
}
```

**Audit Log Model:**
```typescript
interface AuditLog {
  id: string;
  userId: string;
  tenantId: string;
  action: string; // 'user.create', 'dashboard.share', 'user.delete', etc.
  resourceType: string; // 'user', 'dashboard', 'data_source'
  resourceId: string;
  details?: Record<string, any>;
  ipAddress?: string;
  userAgent?: string;
  timestamp: Date;
}
```

**Session Model:**
```typescript
interface Session {
  id: string;
  userId: string;
  token: string;
  expiresAt: Date;
  lastActivityAt: Date;
  ipAddress?: string;
  userAgent?: string;
  createdAt: Date;
}
```

### API Specifications
[Source: docs/architecture/api-specification.md]

**User Management Endpoints:**
- `POST /api/v1/users` - Create user (admin only)
- `GET /api/v1/users` - List users (admin only)
- `GET /api/v1/users/:id` - Get user
- `PUT /api/v1/users/:id` - Update user
- `DELETE /api/v1/users/:id` - Delete user (admin only)
- `POST /api/v1/users/password-reset/initiate` - Initiate password reset
- `POST /api/v1/users/password-reset/complete` - Complete password reset

**Dashboard Sharing Endpoints:**
- `POST /api/v1/dashboards/:id/share` - Share dashboard
- `DELETE /api/v1/dashboards/:id/share/:userId` - Revoke access
- `POST /api/v1/dashboards/:id/public-link` - Generate public link
- `GET /api/v1/public/dashboards/:token` - Access public dashboard
- `GET /api/v1/dashboards/shared` - List shared dashboards

**Audit Log Endpoints:**
- `GET /api/v1/audit-logs` - Get audit logs (admin only)

### Component Specifications
[Source: docs/architecture/components.md]

**UserManager Page:**
- Location: `apps/web/src/pages/UserManager.tsx`
- Purpose: Admin interface for user management
- Features: List, create, edit, delete users

**UserProfile Page:**
- Location: `apps/web/src/pages/UserProfile.tsx`
- Purpose: User profile viewing and editing
- Features: Profile info, password change, preferences

**ShareDialog Component:**
- Location: `apps/web/src/components/dashboard/ShareDialog.tsx`
- Props: `{ dashboardId: string, onClose: () => void }`
- Features: User search, permission selection, public link generation

**SessionTimeout Component:**
- Location: `apps/web/src/components/common/SessionTimeout.tsx`
- Purpose: Handle session timeout and auto-logout
- Features: Inactivity detection, warning dialog, auto-logout

### File Locations
[Source: docs/architecture/unified-project-structure.md]

**Backend:**
- Models: `apps/api/src/models/User.ts` (update)
- Services: `apps/api/src/services/userService.ts`, `apps/api/src/services/auditService.ts`
- Controllers: `apps/api/src/controllers/userController.ts`
- Routes: `apps/api/src/routes/userRoutes.ts`
- Middleware: `apps/api/src/middleware/authorization.ts`
- Tests: `apps/api/src/__tests__/`

**Frontend:**
- Pages: `apps/web/src/pages/UserManager.tsx`, `apps/web/src/pages/UserProfile.tsx`, `apps/web/src/pages/PasswordReset.tsx`
- Components: `apps/web/src/components/forms/UserForm.tsx`, `apps/web/src/components/dashboard/ShareDialog.tsx`, `apps/web/src/components/common/SessionTimeout.tsx`
- Services: `apps/web/src/services/userService.ts`
- State: `apps/web/src/stores/userSlice.ts`
- Tests: `apps/web/src/__tests__/`

### Testing Requirements
[Source: docs/architecture/testing-strategy.md]

**Unit Tests:**
- Test user CRUD operations
- Test permission validation
- Test password reset token generation and validation
- Test audit logging
- Test session management

**Integration Tests:**
- Test user management endpoints with role checks
- Test dashboard sharing with permission validation
- Test public link generation and access

**E2E Tests:**
- Test complete user management workflow
- Test dashboard sharing workflow
- Test password reset flow
- Test session timeout

### Technical Constraints
[Source: docs/architecture/tech-stack.md, docs/architecture/coding-standards.md]

**Password Reset:**
- Generate secure random token (32 bytes)
- Token expiration: 1 hour
- Store token hash in database
- Send reset link via email (email service to be implemented)

**Session Management:**
- Session expiration: 1 hour (configurable)
- Inactivity timeout: 30 minutes
- Store sessions in Redis for performance
- Refresh session on user activity

**Audit Logging:**
- Log all sensitive operations (user create/delete, dashboard share, etc.)
- Store IP address and user agent
- Retention period: 90 days (configurable)
- Admin-only access to audit logs

**Authorization:**
- Admin role can manage all users
- Users can only edit their own profile
- Dashboard owners can share their dashboards
- Validate permissions on every request

**Security:**
- Validate user has permission to perform action
- Enforce tenant isolation
- Rate limit password reset requests (5 per hour per IP)
- Validate password strength (min 8 chars, letter + number)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-05 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-05 | 1.1 | Backend implementation complete (Tasks 1-7) | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 via Augment Agent

### Debug Log References
None

### Completion Notes List
- Implemented backend user management (models, services, controllers, routes)
- Enhanced User model with profile fields, password reset tokens, soft delete
- Added user CRUD operations with password hashing (bcrypt)
- Implemented password reset flow with token generation and validation
- Created dashboard sharing service with user-to-user and public link sharing
- Implemented audit logging service with filtering and pagination
- Created session management service with expiration and activity tracking
- Added comprehensive unit and E2E tests for all services
- Frontend tasks (8-13) deferred - require React/UI infrastructure setup

### File List
**Created:**
- apps/api/src/models/User.ts (enhanced)
- apps/api/src/models/DashboardShare.ts
- apps/api/src/models/AuditLog.ts
- apps/api/src/models/UserSession.ts
- apps/api/src/services/userService.ts
- apps/api/src/services/dashboardSharingService.ts
- apps/api/src/services/auditService.ts
- apps/api/src/services/sessionService.ts
- apps/api/src/controllers/userController.ts
- apps/api/src/controllers/dashboardSharingController.ts
- apps/api/src/validators/userValidators.ts
- apps/api/src/validators/dashboardSharingValidators.ts
- apps/api/src/routes/userRoutes.ts
- apps/api/src/routes/dashboardSharingRoutes.ts
- apps/api/src/middleware/auditLog.ts
- apps/api/src/services/__tests__/userService.test.ts
- apps/api/src/services/__tests__/dashboardSharingService.test.ts
- apps/api/src/services/__tests__/auditService.test.ts
- apps/api/src/services/__tests__/sessionService.test.ts
- apps/api/src/__tests__/e2e/user.e2e.test.ts
- apps/api/src/__tests__/e2e/dashboardSharing.e2e.test.ts

**Modified:**
- apps/api/src/database/schema.sql (added user profile fields, dashboard_shares, public_dashboard_links, audit_logs, user_sessions tables with indexes)
- apps/api/src/server.ts (added user and dashboard sharing routes)

## QA Results
(To be filled by QA Agent)

