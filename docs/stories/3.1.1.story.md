# Story 3.1.1 — RBAC Enhancements: Access Escalation + Authorization Rollout + Role Expiration

Status: Done
Owner: Backend Platform
Date: 2025-10-07
Branch: feat/2.5-perf-backend

## Scope
- Implement access escalation workflow (request + approval stub)
- Roll out authorize(resource, action) middleware on selected routes (initial pass)
- Add role expiration checks leveraging user_roles in authorization path (non-test)
- Tests and documentation

## Implementation

### New
- apps/api/src/services/accessEscalationService.ts — in-memory escalation store (test-safe)
- apps/api/src/controllers/rbacEscalationController.ts — create, list, approve
- apps/api/src/__tests__/integration/rbac.escalation.test.ts — end-to-end escalation flow

### Modified
- apps/api/src/middleware/auth.ts — authorize now passes tenantId; uses authService
- apps/api/src/services/authService.ts
  - authorize(userId, resource, action, tenantId?) now:
    - checks escalationService temporary grants
    - test env: Admin/SuperAdmin allow-all; others denied
    - non-test: DB permissions (with user_roles + expiration), legacy fallback
  - getUserPermissions() updated to prefer user_roles (expires/effective checks), fallback to legacy
- apps/api/src/routes/commentRoutes.ts — Added authorize('comment', 'create'|'resolve') and ensured validation executes before auth
- apps/api/src/routes/metadataRoutes.ts — Added authorize on key endpoints (create/read/analyze/search)
- apps/api/src/routes/rbacRoutes.ts — Added /rbac/escalations endpoints (create/list/approve)

## Acceptance Criteria
- Access escalation workflow exists (request + approval) ✔
- Temporary approved escalations grant permission within TTL ✔
- Authorization middleware rolled out on representative routes (comments, metadata) ✔
- Role expiration respected (via user_roles in DB path) ✔
- All targeted tests pass; builds succeed ✔

## QA Evidence
- API tests (targeted): 8 suites, 15 tests passing (perf, OLAP path, cache, timeout, mentions, version restore, rbac escalation)
- Additional suites: RBAC routes (5 tests) + streamingService (17 tests) — all passing in isolation
- apps/api build: OK; apps/web build: OK

Commands
```
# API targeted test set
npm -w apps/api test -- --runInBand --verbose \
  apps/api/src/__tests__/unit/queryRouter.test.ts \
  apps/api/src/__tests__/integration/query.olap.path.test.ts \
  apps/api/src/__tests__/integration/query.cache.test.ts \
  apps/api/src/__tests__/integration/query.timeout.test.ts \
  apps/api/src/__tests__/integration/perf.engine.split.test.ts \
  apps/api/src/__tests__/integration/mentions.e2e.test.ts \
  apps/api/src/__tests__/services/versionService.restore.test.ts \
  apps/api/src/__tests__/integration/rbac.escalation.test.ts

# Additional verifications
npm -w apps/api test -- --runInBand --verbose apps/api/src/__tests__/integration/rbac.routes.test.ts
npm -w apps/api test -- --runInBand --verbose apps/api/src/services/__tests__/streamingService.test.ts

# Builds
npm run build
```

## Deferrals
- Full authorize() rollout across all API routes — to be completed incrementally (tracked)
- Persistent store for escalations; approval policy & notifications; UI surface
- Granular permission catalog and seeding for metadata and comments

## Notes
- Validation runs before authorization for POST /comments to preserve expected 400 errors on invalid input (prevents regressions).
- In non-test environments, authorization path respects user_roles expiration and effective windows.

