# Story 3.3: Collaboration Features

## Status
Draft

## Story
As a team member, I want real-time collaboration on dashboards (co-editing, comments, versions) so that teams work efficiently.

## Scope
- In-scope: Co-editing, comments with mentions, sharing levels, versioning, activity feed, workspaces, Slack/Teams integration.
- Out-of-scope: SSO (3.2), RBAC policy (3.1 provides permission checks).

## Acceptance Criteria (Given/When/Then)
1) Co-editing
- Given two editors open same dashboard
- When both make changes
- Then presence is visible and conflicts resolve via OT/CRDT; last-write-wins only for non-critical fields

2) Comments & Mentions
- Given a dashboard
- When I add a comment with @mention
- Then the mentioned users get notifications and a thread appears with resolve status

3) Sharing Levels
- Given permission dialog
- When I share with users/roles
- Then levels: view/comment/edit/admin apply and are enforced

4) Version History
- Given a dashboard
- When I open versions
- Then I can see diffs (layout/components/config), restore previous versions, and add labels

5) Activity Feed
- Given a workspace
- When events occur
- Then feed shows edits, shares, comments, publish actions with timestamps and actors

6) Workspaces
- Given teams
- When creating a workspace
- Then dashboards can be organized under team with scoped permissions

## Data Model / Migrations
- comments(id, dashboard_id, user_id, body, mentions[], resolved, created_at)
- dashboard_versions(id, dashboard_id, version, diff jsonb, label, created_at, author_id)
- activities(id, workspace_id?, dashboard_id?, type, actor_id, details jsonb, at)
- workspaces(id, name, owner_id, settings jsonb, created_at)

## APIs
- /api/v1/comments [POST/GET/PUT]
- /api/v1/dashboards/:id/versions [GET/POST/PUT]
- /api/v1/activities [GET]
- /api/v1/workspaces [CRUD]
- /api/v1/shares [POST/DELETE]

## Real-time
- Reuse WS from 2.4 for presence, comment updates, co-edit ops

## Security
- Permission checks via RBAC; input sanitation; rate limit comments

## Observability
- Metrics: collab.presence, comment.count, share.events, version.restore

## Performance
- Co-edit latency < 300ms; comment publish < 500ms

## Rollout/Backout
- Feature flags per feature (coedit/comments/versioning)

## Risks & Mitigations
- R: Merge conflicts -> M: OT/CRDT lib, field locking
- R: Spam mentions -> M: rate limit, notification prefs

## UX/Design
- Presence avatars; inline comment pins; version diff viewer; share dialog

## Testing Strategy
- Unit: OT ops, diff builder
- Integration: comments + notifications, share enforcement
- E2E: two-browsers co-edit scenario; restore version

## Tasks / Subtasks
1. Data model + migrations
2. Co-edit service (OT/CRDT)
3. Comment service + notifications
4. Versions + diff/restore
5. Activities + UI
6. Workspaces + UI
7. Tests + docs

## NFRs
- Security: sanitize content; enforce perms
- Reliability: idempotent ops; WS reconnect

## DoD
- [ ] Co-edit stable with tests
- [ ] Comments + mentions delivered
- [ ] Version restore reliable
- [ ] Tests >= 80%

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 2.0 | Regenerated with exhaustive spec | Bob |

## Dev Agent Record
(To be filled by Dev)

## QA Results
(To be filled by QA)

