# Story 2.5.5 — Cross-Engine Materialized Views (ClickHouse Analytical MVs)

## Status
Done (implemented and verified)

## Summary
Extend Materialized Views (MV) to support cross-engine materialization in ClickHouse (OLAP) in addition to OLTP. Analytical MVs in ClickHouse drastically reduce latency for rollups and shift heavy compute off the OLTP path. This story extends the MV catalog, refresh scheduler, and query rewriter with an engine dimension while preserving safety and compatibility.

## Scope (MVP)
- MV Catalog: add `engine`, `targetDatabase`, `chOpts` to define ClickHouse MVs
- Scheduler: refresh dispatcher supports engine='olap' (ClickHouse) and 'oltp'
- Query Rewriter: selects CH MVs and forces OLAP execution; attaches `mv.engine` metadata
- API: extend MV CRUD/refresh endpoints to accept/validate engine fields
- Observability: perf counters by engine; response metadata includes engine

Non-goals (this story): incremental/CDC refresh; table-swap strategy; advanced CH storage tuning; UI management

## Feature Flags
- MV_ENABLE=false
- MV_REWRITE_ENABLE=false
- MV_AUTO_REFRESH_ENABLE=false
- MV_AUTO_DETECT_ENABLE=false
- MV_MAX_STALENESS_MS=600000
- MV_SCHEDULER_INTERVAL_MS=60000
- MV_CROSS_ENGINE_ENABLE=false (new) — master switch for cross-engine features
- MV_CH_DATABASE=analytics (optional default)
- MV_CH_STORAGE=MergeTree (optional)
- MV_CH_REFRESH_CONCURRENCY=1 (optional)

## Architecture
1) Catalog: store engine and CH options alongside normalized signature and existing fields
2) Scheduler: engine-based dispatch; serialize per MV; update status/metrics; noop when disabled
3) Rewriter: if eligible MV has engine='olap', rewrite to CH table namespace and force OLAP execution (via SQL hint) with mv metadata
4) API: extend request/response schemas; validation for engine-specific fields
5) Observability: counters by engine; request metadata `metadata.mv.engine`

## Data Model
- Add to materialized_views:
  - engine text check in ('oltp','olap') default 'oltp'
  - target_database text nullable (for 'olap')
  - ch_opts jsonb default '{}'::jsonb
- Backwards compatible; existing rows default to 'oltp'

## API (MVP)
- POST /api/v1/mv: { name, definitionSql, engine?, targetDatabase?, chOpts?, ... }
- PATCH /api/v1/mv/:id: engine-aware validation; updates fields
- GET /api/v1/mv, /mv/:id: include engine fields
- POST /api/v1/mv/:id/refresh: refreshes per engine type

## Acceptance Criteria
- Catalog accepts/returns engine fields (default 'oltp') and validates values
- Scheduler refreshes CH MVs (mocked CH ops in tests) and updates lastRefreshedAt/status
- Rewriter routes to CH MVs when eligible; attaches mv.engine='olap' in metadata; forces OLAP engine
- Flags default disabled; behavior unchanged when MV_CROSS_ENGINE_ENABLE=false
- Tests: ≥20 new tests (≥15 unit + ≥5 integration) for cross-engine features; existing 25 MV tests continue to pass
- Builds pass for api and web

## Risks & Mitigations
- Correctness parity: strict signature + TTL; conservative bypass on mismatch
- Refresh cost spikes: serialize; keep concurrency low; staging rollout
- Tenancy isolation: tenant checks for all reads; CH table namespace includes database
- CH DDL drift: validate existence; minimal chOpts in MVP

## Verification Strategy
- Unit: catalog engine validation; rewriter engine selection; scheduler CH dispatch; perf counters by engine
- Integration: API CRUD with engine='olap'; rewrite integration shows mv.engine='olap'; scheduler refresh with fake timers marks success
- Regression: with MV_CROSS_ENGINE_ENABLE=false, system behaves as before
- Build: `npm run build`

## Rollout
- Phase 0: Flags disabled (default)
- Phase 1: Enable catalog + API in staging (no rewrite)
- Phase 2: Enable scheduler refresh for a subset
- Phase 3: Enable rewrite for allowlisted queries; monitor metrics

## QA Evidence
- Cross-engine MV tests: 20/20 passing (17 suites)
- Existing MV suite: 25/25 passing (12 suites)
- Regression: query optimizer (14 tests) and query router (4 tests) passing
- Builds: apps/api TypeScript build OK; apps/web Vite build OK
- Flags: all MV flags including MV_CROSS_ENGINE_ENABLE default to false; behavior unchanged when disabled

