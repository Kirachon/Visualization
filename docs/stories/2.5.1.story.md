# Story 2.5.1 — ClickHouse Analytical Path

Status: Done
Owner: Backend
Date: 2025-10-07

## Summary
Implements an analytical query path using a ClickHouse abstraction behind a feature flag, adds deterministic engine routing heuristics, integrates engine selection into the Query Controller, and ensures cache isolation between OLTP (primary DB) and OLAP (ClickHouse) engines. Includes targeted tests and documentation.

## Scope
- ClickHouse service abstraction (mocked in tests)
- Engine selection heuristics: preferOlap flag, SQL hint, analytical pattern detection (GROUP BY, WINDOW)
- Controller integration: choose engine, execute on selected backend, record perf, audit, and return metadata.engine
- Cache isolation: engine is part of cache key to avoid cross-engine contamination

## Feature Flags and Controls
- CLICKHOUSE_ENABLE=true — Enables OLAP execution path. If false/absent, controller falls back to OLTP and metadata.engine reflects 'oltp'
- SQL hint: /*+ engine=olap */ — Forces analytical engine routing
- Request body param: useOlap: true — Forces analytical engine routing

## API Behavior
- POST /api/v1/data-sources/:id/query
  - Body: { sql, params?, limit?, offset?, timeoutMs?, connectionConfig?, useOlap? }
  - Response: { rows, rowCount, executionTime, metadata: { engine: 'oltp' | 'olap', cacheHit: boolean, sqlHash } }

## Acceptance Criteria
- [x] Heuristics choose 'olap' for GROUP BY/WINDOW queries, hint, or prefer flag; otherwise 'oltp'
- [x] When CLICKHOUSE_ENABLE=false, query executes on OLTP and metadata.engine='oltp'
- [x] Cache keys include engine to isolate OLTP/OLAP results. Hitting the opposite engine does not yield a false cache hit
- [x] Existing query cache and timeout behavior remain backward compatible
- [x] Tests verify routing, fallback, cache isolation, and metadata correctness

## QA Evidence (Tests)
- Unit: apps/api/src/__tests__/unit/queryRouter.test.ts — 4 tests
- Integration: apps/api/src/__tests__/integration/query.olap.path.test.ts — 3 tests
- All previous suites remain passing (RBAC, collaboration, versioning, cache, timeout)

## Deferrals / Out of Scope
- Real ClickHouse client, connection pooling, TLS, query formatting
- Cost-based routing and optimizer hints catalog
- Materialized views and refresh scheduler

## Changelog
- 2025-10-07: Initial implementation complete — engine heuristics, controller integration, cache isolation, tests

