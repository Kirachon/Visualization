# Story 2.5: Query Performance Optimization

## Status
Done (Phase 1: cache + timeout mapping + perf endpoints); Deferrals documented (ClickHouse, optimizer, MVs)

## Story
As a system administrator, I want sub-second queries on large datasets via caching, optimization, and analytical engines so that users have a responsive experience.

## Scope
- In-scope: ClickHouse path, caching, optimizer, materialized views, timeouts/cancel, perf dashboards.
- Out-of-scope: Full pipeline optimization (4.x epics).

## Acceptance Criteria (Given/When/Then)
1) Analytical Path
- Given a heavy analytical query
- When routed to ClickHouse
- Then results return < 1s (p95) for 1M rows via columnar storage and pre-aggregation where applicable

2) Caching
- Given repeat queries with identical predicates
- When executed within TTL
- Then cache hit returns in < 200ms and metadata shows cacheHit=true

3) Optimizer
- Given an inefficient SQL
- When optimizer runs
- Then we log plan analysis and optionally rewrite (add projections/indices hints) improving runtime >= 30%

4) Materialized Views
- Given frequently used aggregates
- When configured
- Then MV refresh schedules maintain freshness with < 5m lag and queries leverage MVs automatically

5) Controls
- Given long-running query
- When exceeding 30s
- Then server cancels and returns 504 with guidance; user can cancel via UI

6) Observability
- Given performance dashboard
- When monitoring
- Then slow queries, cache hit rate, and engine split (OLTP vs OLAP) are visible

## API Specifications
- Base: /api/v1/perf
- GET /queries/slow?since= -> [ { id, sqlHash, p95, count } ]
- GET /cache/stats -> { hitRate, items, size }
- POST /optimize/analyze { sql } -> { plan, recommendations }
- POST /mv { def } -> { id }

## Data Model / Migrations
- query_stats(id, tenant_id, sql_hash, duration_ms, at)
- cache_entries(key, hit_count, last_hit_at, size)
- materialized_views(id, tenant_id, definition jsonb, refresh_cron, last_refreshed_at)

## Architecture
- Router: choose Postgres vs ClickHouse based on heuristics/annotations
- Cache: Redis with TTL and invalidation on writes; keys by sql+bindings+role
- Optimizer: EXPLAIN-based analysis; hints catalog

## Security
- Donâ€™t cache role-restricted data across roles; encrypt cache keys at rest; redact literals in logs

## Performance Targets
- p95 < 1s for analytical queries (pre-aggregated/OLAP); cache hit < 200ms; hit rate > 80%

## Observability
- Metrics: query.duration, cache.hit_rate, mv.refresh.duration, cancel.count
- Tracing spans around router/cache/engine

## Rollout/Backout
- Feature flags per sub-feature; conservative default off for rewriter

## Risks & Mitigations
- R: Cache staleness -> M: write-through or explicit invalidation hooks
- R: Rewrites breaking semantics -> M: safe-mode, diff checks

## UX/Design Notes
- QueryEditor shows engine used (OLTP/OLAP), cache badge, cancel button, runtime breakdown

## Testing Strategy
- Unit: cache keys, optimizer rules
- Integration: ClickHouse via docker, MV creation/refresh
- E2E: dashboard latency before/after; cancel

## Tasks / Subtasks
1. Router + heuristics
2. Redis cache service
3. Optimizer (analyze/rewrite)
4. MV service + scheduler
5. Perf dashboards
6. Tests + docs

## NFRs
- Security: per-tenant/role cache isolation
- Reliability: retries/backoff for CH; graceful degradation to OLTP

## DoD
- [ ] Hit rate and p95 meet targets
- [ ] Cancel works; timeouts enforced
- [x] Cache hit path returns <200ms with metadata.cacheHit=true (tested)
- [x] Timeout/cancellation maps to 504 with guidance (tested)
- [/] ClickHouse analytical path deferred
- [/] Optimizer analyze/rewrite deferred behind feature flag
- [/] Materialized views service and scheduler deferred

- [ ] Perf dashboards deployed
- [ ] Tests >= 80%
| 2025-10-07 | 2.1 | Implemented query cache (Redis/in-memory), timeout mapping to 504, cache stats + slow queries endpoints, tests | Dev Agent (The Augster) |


## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 2.0 | Regenerated with exhaustive spec | Bob |
| 2025-10-07 | 2.1 | Phase 1 completed (cache + timeouts + perf endpoints) | Dev Agent (The Augster) |

| 2025-10-05 | 2.0 | Regenerated with exhaustive spec | Bob |

## Dev Agent Record
(To be filled by Dev)

## QA Results
(To be filled by QA)

