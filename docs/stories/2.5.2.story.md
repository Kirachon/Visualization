# Story 2.5.2: Query Optimizer (Analyze/Rewrite + Hints)

## Status
Done

## Story
As a data engineer, I want the system to analyze SQL and suggest or apply safe optimizations so that queries run faster without manual tuning.

## Scope
- Analyze SQL using PostgreSQL EXPLAIN (FORMAT JSON)
- Generate optimization recommendations (e.g., index usage, seq scans, missing predicates)
- Optional, conservative rewrites behind feature flag
- Integrate with query execution path to surface optimizer metadata
- API endpoint to analyze a query without executing

## Acceptance Criteria
- POST /api/v1/optimize/analyze returns `{ plan, cost, recommendations }` for provided SQL
- When OPTIMIZER_ENABLE=true, query execution path annotates response metadata with optimizer info
- When OPTIMIZER_REWRITE_ENABLE=true, only safe rewrites are applied; semantics preserved
- Unit tests (>=10) cover recommendation generation and rewrite safety
- Integration tests (>=3) cover endpoint behavior and feature flags
- Builds succeed for apps/api and apps/web; no regressions in perf tests

## API
- POST /api/v1/optimize/analyze { sql, dataSourceId?, connectionConfig? }
  - 200: { plan, totalCost, recommendations: [{ type, message, table?, column? }], rewrittenSql? }
  - 400: invalid input

## Feature Flags
- OPTIMIZER_ENABLE (default: false)
- OPTIMIZER_REWRITE_ENABLE (default: false)
- OPTIMIZER_TEST_MOCK_PLAN (tests): use deterministic mocked plans

## Architecture & Integration
- New service: QueryOptimizerService
  - analyze(sql, connectionConfig?): EXPLAIN JSON (or mocked plan in tests)
  - generateRecommendations(plan): extract hints
  - rewrite(sql, hints): conservative, safe-only (no semantic changes)
- New controller: optimizerController (POST /optimize/analyze)
- queryController: pre-execution hook to analyze (and optionally rewrite) when enabled; metadata attached to response
- perfService: track optimizer invocation/rewrite counters (optional)

## Risks & Mitigations
- Risk: Rewrites change semantics → Mitigation: default analyze-only; conservative rewrites; explicit feature flag
- Risk: DB dependency in tests → Mitigation: test-mode mocked plans
- Risk: Plan parsing variability → Mitigation: focus on common fields (Node Type, Total Cost)

## Verification Strategy & QA Evidence
- Unit: queryOptimizerService (10 tests) — PASS
- Integration: optimize/analyze endpoint (3 tests) — PASS
- Integration: optimizer metadata in query response when enabled (1 test) — PASS
- Regression: cache, OLAP routing, timeout, engine split (7 tests) — PASS
- Build: `npm run build` — PASS

## Deferrals
- Advanced rewrites (JOIN reordering, subquery flattening)
- Persistent hint catalog and learning
- UI surfacing of recommendations in QueryEditor

## Change Log
| Date       | Version | Description                         | Author                    |
|------------|---------|-------------------------------------|---------------------------|
| 2025-10-07 | 1.0     | Plan created and implementation started | Dev Agent (The Augster) |

