# Story 3.2: Enterprise Authentication Integration

## Status
Draft

## Story
As an IT administrator, I want SAML/OIDC/LDAP integration with MFA and provisioning so that SSO and centralized identity are enabled.

## Scope
- In-scope: SAML 2.0, OAuth2/OIDC providers, LDAP/AD, MFA (TOTP), JIT provisioning, sessions, auth monitoring.
- Out-of-scope: RBAC policy (3.1), which consumes identities.

## Acceptance Criteria (Given/When/Then)
1) SAML 2.0
- Given configured IdP metadata
- When SP-initiated login occurs
- Then user is authenticated, attributes mapped, and JIT-provisioned if new

2) OIDC
- Given configured OIDC provider (e.g., Okta)
- When OAuth2 code flow with PKCE finishes
- Then tokens are validated (nonce, audience) and session established

3) LDAP/AD
- Given LDAP endpoint and bind DN
- When user authenticates
- Then credentials verified and attributes synced; LDAPS enforced

4) MFA
- Given user enables MFA
- When logging in
- Then TOTP is required after primary auth; recovery codes supported

5) Provisioning
- Given first-time SSO
- When user not found
- Then create user with mapped roles and default tenant; deprovision on IdP signal

6) Session Management
- Given session limit and inactivity timeout
- When exceeded or idle
- Then sessions are revoked; logout-all supported

7) Monitoring & Alerts
- Given abnormal failures
- When thresholds exceed
- Then alerts dispatched to security channel

## Data Model
- idp_configs(id, type: 'saml'|'oidc'|'ldap', config jsonb, tenant_id)
- users(id, email, external_id, provider, mfa_enabled, mfa_secret, status)
- sessions(id, user_id, token_hash, created_at, last_activity_at, ip, ua)
- provisioning_events(id, user_id, type, at, raw)

## APIs
- /api/v1/auth/saml/acs [POST]
- /api/v1/auth/oidc/callback [GET]
- /api/v1/auth/ldap/login [POST]
- /api/v1/auth/mfa/setup [POST] -> QR, [POST verify]
- /api/v1/auth/sessions [GET/DELETE]
- /api/v1/idp-configs [CRUD]

## Security
- Validate signatures; store only token hashes; enforce TLS; replay protection (nonce/state); fail-closed defaults

## Observability
- Metrics: auth.success/failure, mfa.challenge, sessions.active, provision.events
- Logs: redacted tokens; correlation IDs across flows

## Performance
- Median SSO < 2s; IdP time excluded

## Rollout/Backout
- Enable providers per tenant; backout by provider disable

## Risks & Mitigations
- R: Clock skew -> M: leeway and NTP
- R: Token leakage -> M: httpOnly/secure, minimal scopes

## UX/Design
- SSO buttons; MFA setup wizard; session list with revoke; clear error states

## Testing Strategy
- Unit: token validators; attribute mapping
- Integration: SAML/OIDC against test IdPs; LDAP in docker
- E2E: SSO + MFA + session revoke

## Tasks / Subtasks
1. Provider clients and configs
2. Attribute mapping + provisioning
3. MFA setup/verify
4. Session store + UI
5. Monitoring + alerts
6. Tests + docs

## NFRs
- Security: strict validation, mTLS optional
- Reliability: retries/backoff to IdP, circuit breaker

## DoD
- [ ] SAML/OIDC/LDAP + MFA functional end-to-end
- [ ] Sessions manageable with revoke
- [ ] Alerts on auth anomalies
- [ ] Tests >= 85%

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 2.0 | Regenerated with exhaustive spec | Bob |

## Dev Agent Record
(To be filled by Dev)

## QA Results
(To be filled by QA)

