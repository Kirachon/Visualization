# Story 5.1: Plugin Architecture

## Status
Draft

## Story
As a developer, I want a secure, versioned plugin system (frontend/backend SDKs, registry, sandboxing) so that the platform can be extended safely.

## Scope
- In-scope: Frontend SDK (TS/React), Backend SDK (Node), registry/marketplace, isolation/sandbox, versioning/deps, testing/validation, docs/examples.
- Out-of-scope: Third-party revenue/billing (later).

## Acceptance Criteria (Given/When/Then)
1) Frontend SDK
- Given a plugin author
- When building a chart plugin
- Then lifecycle (register, mount, update, unmount) works with typed props and capability declarations

2) Backend SDK
- Given a server plugin
- When registering routes/hooks
- Then plugin can add connectors/middleware with isolation and capability checks

3) Registry & Marketplace
- Given a packaged plugin (manifest/signature)
- When publishing
- Then registry validates, versions, scans, and lists in marketplace for install

4) Isolation & Security
- Given an installed plugin
- When running
- Then it executes in sandbox (VM2/isolated-vm), with resource limits and no privileged APIs unless granted

5) Versioning & Deps
- Given semver ranges
- When resolving
- Then compatible versions are selected; conflicts detected with clear remediation

6) Testing & Validation
- Given a plugin package
- When validated
- Then schema, API, and security scans pass, including static analysis and dependency audit

## Data Model / Migrations
- plugins(id, name, version, author, manifest jsonb, signature, capabilities[], status)
- plugin_installs(id, tenant_id, plugin_id, config jsonb, status, installed_at)
- plugin_events(id, plugin_id, type, details jsonb, at)

## SDKs
- Frontend: packages/plugin-sdk-frontend (registerComponent, capability flags, events)
- Backend: packages/plugin-sdk-backend (registerRoute, registerConnector, hooks, lifecycle)

## APIs
- /api/v1/plugins [CRUD, publish]
- /api/v1/plugins/:id/install [POST]
- /api/v1/plugins/:id/enable [POST]
- /api/v1/plugins/:id/disable [POST]

## Security
- Sign manifests; verify signatures; sandbox; permission prompts; CSP; content sanitization

## Observability
- Metrics: plugin.exec.time, errors, memory, sandbox.violations

## Performance
- Sandbox init < 200ms; memory < 64MB per plugin instance by default

## Rollout/Backout
- Tenant-level enable/disable; safe backout by disabling plugin; configs preserved

## Risks & Mitigations
- R: Sandbox escape -> M: minimal surface, audits, auto updates
- R: Supply-chain -> M: signatures, SCA, provenance

## UX/Design
- PluginMarketplace page; install dialog with permissions; plugin manager list with health

## Testing Strategy
- Unit: SDK APIs; manifest validator
- Integration: install/enable/disable; sandbox policy
- E2E: create sample plugin and run in dashboard

## Tasks / Subtasks
1. Data model + APIs + registry service
2. Frontend SDK + examples
3. Backend SDK + examples
4. Sandbox integration + policies
5. Marketplace UI
6. Tests + docs

## NFRs
- Security: signatures, sandbox, least privilege
- Reliability: crash isolation, watchdog

## DoD
- [ ] SDKs GA with docs
- [ ] Registry + marketplace live
- [ ] Plugins run safely in sandbox
- [ ] Tests >= 85%

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 2.0 | Regenerated with exhaustive spec | Bob |

## Dev Agent Record
(To be filled by Dev)

## QA Results
(To be filled by QA)

